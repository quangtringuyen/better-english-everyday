events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # Trust X-Forwarded-For header from Docker network
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 10.0.0.0/8;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # Custom JSON Log Format with real client IP
    log_format json_analytics escape=json
      '{'
        '"timestamp": "$time_iso8601",'
        '"ip": "$remote_addr",'
        '"forwarded_for": "$http_x_forwarded_for",'
        '"method": "$request_method",'
        '"path": "$request_uri",'
        '"status": "$status",'
        '"ua": "$http_user_agent"'
      '},';

    # Write logs to the resources folder (mapped volume) so they persist and are accessible
    # Note: We verify permissions in entrypoint or assume volume is writable
    access_log /usr/share/nginx/html/resources/visitors.log json_analytics;
    error_log  /var/log/nginx/error.log warn;

    server {
        listen       80;
        server_name  localhost;

        root   /usr/share/nginx/html;
        index  index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        # Expose resources (and the log file)
        location /resources/ {
            alias /usr/share/nginx/html/resources/;
            autoindex on;
            # Don't log requests to the log file itself to reduce noise
            location /resources/visitors.log {
                access_log off;
                add_header Cache-Control "no-store, no-cache, must-revalidate";
            }
        }
    }
}
